library(SummarizedExperiment)
library(limma)

counts <- readRDS("counts_brca.rds")
row_data <- rowData(counts)
cou <- assay(counts)

protein_coding_genes <- row_data$gene_type == "protein_coding"
protein_coding_counts <- cou[protein_coding_genes, ]

protein_coding_counts <- protein_coding_counts[rowSums(protein_coding_counts) > 10, ]

protein_coding_expression_data <- counts[rownames(protein_coding_counts), ]


clinical_data <- colData(protein_coding_expression_data)
group <- factor(clinical_data$definition)
group <- relevel(group, ref="Solid Tissue Normal")
design <- model.matrix(~group)

dge <- DGEList(counts=assay(protein_coding_expression_data),
                samples=colData(protein_coding_expression_data),
                genes=as.data.frame(rowData(protein_coding_expression_data)))


keep <- filterByExpr(dge, design)
dge <- dge[keep,,keep.lib.sizes=FALSE]

v <- calcNormFactors(dge)
v <- voom(v, design)

fit_l <- lmFit(v, design)
fit_l <- eBayes(fit_l)
r <- topTable(fit_l, coef = 2, n = Inf)
table(r$adj.P.Val < 0.01)
summary(r$adj.P.Val < 0.01)
s <- r[r$adj.P.Val < 0.01, ]
write.csv(s, "protein_dea_genes_limma_padj.csv")

mydgelist_de <- decideTests(fit_l, p = 0.01)
summary(mydgelist_de)